---
/**
 * ProjectsBlock.astro
 * Bloque de Proyectos Destacados (Slider Circular 3D)
 */
import { getCollection } from "astro:content";
import MosaicSecondaryBg from "@/components/ui/MosaicSecondaryBg.astro";

interface Props {
  title?: string;
  subtitle?: string;
  ctaText?: string;
  ctaLink?: string;
}

const {
  title = "Proyectos Destacados",
  subtitle = "Conoce nuestros proyectos más recientes",
  ctaText,
  ctaLink,
} = Astro.props;

// Fetch top 4 projects for the slider
const projects = (await getCollection("proyectos")).slice(0, 4);
---

<section class="w-full py-12 lg:py-20 relative overflow-hidden bg-brand-secondary">
  <!-- SVG Background -->
  <div class="absolute inset-0 w-full h-full pointer-events-none opacity-20">
    <MosaicSecondaryBg />
  </div>

  <div class="container mx-auto px-4 relative z-10">
    <!-- Header Section -->
    <div class="text-center mb-12" data-aos="fade-up" data-aos-duration="1000">
      <div class="inline-flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full border border-white/20 mb-6">
        <div class="w-2 h-2 bg-[#D79528] rounded-full"></div>
        <span class="font-heebo font-semibold text-sm text-[#D79528] tracking-wider uppercase">
          Nuestros Proyectos
        </span>
      </div>
      <h2 class="font-urbanist font-bold text-4xl lg:text-6xl text-white mb-6">
        {title}
      </h2>
      <p class="font-heebo text-lg lg:text-xl text-neutral-300 max-w-2xl mx-auto">
        {subtitle}
      </p>
    </div>

    <!-- Swiper Container -->
    <div class="portfolio-slider swiper w-full max-w-[1400px] mx-auto pb-12">
      <div class="swiper-wrapper">
        {projects.map((project) => (
          <div class="swiper-slide w-[350px] md:w-[600px] lg:w-[800px]">
            <div class="group relative bg-white rounded-3xl overflow-hidden shadow-2xl transition-all duration-300">
              
              <!-- Image Container -->
              <div class="relative h-[250px] md:h-[400px] overflow-hidden">
                <img 
                  src={project.data.backgroundImage} 
                  alt={project.data.title}
                  class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                
                <!-- Floating Badge -->
                <div class="absolute top-4 left-4">
                  <span class="px-3 py-1 bg-white/90 backdrop-blur rounded-lg text-xs font-bold text-neutral-800 uppercase tracking-wide">
                    {project.data.tags?.[0] || "Residencial"}
                  </span>
                </div>

                <!-- Title on Image -->
                <div class="absolute bottom-6 left-6 right-6">
                  <h3 class="font-urbanist font-bold text-2xl md:text-4xl text-white leading-tight">
                    {project.data.title}
                  </h3>
                </div>
              </div>

              <!-- Content Body -->
              <div class="p-6 md:p-8 bg-white relative">
                <p class="font-heebo text-neutral-500 text-sm md:text-base mb-6 line-clamp-2">
                  {project.data.description}
                </p>
                
                <div class="flex items-center justify-between border-t border-neutral-100 pt-6">
                  <a href={`/proyectos/${project.slug}`} class="inline-flex items-center gap-2 px-6 py-2.5 rounded-full border border-neutral-300 text-neutral-700 font-medium hover:bg-neutral-900 hover:text-white hover:border-neutral-900 transition-all duration-300">
                    Ver más
                  </a>
                  <div class="hidden md:flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span class="text-xs font-bold text-neutral-400 uppercase tracking-widest">
                      {project.data.specifications?.deliveryDate?.label || "DISPONIBLE"}
                    </span>
                  </div>
                </div>
              </div>

            </div>
          </div>
        ))}
      </div>
      
      <!-- Pagination -->
      <div class="swiper-pagination mt-8"></div>
    </div>

    {/* CTA footer if needed */}
    {ctaText && ctaLink && (
       <div class="text-center mt-8">
          <a href={ctaLink} class="inline-block px-8 py-3 bg-primary text-white rounded-full font-bold hover:bg-primary-dark transition-colors">
             {ctaText}
          </a>
       </div>
    )}

  </div>
</section>

<style>
  /* Swiper styles override */
  .swiper-slide {
    transition: all 0.5s ease;
    opacity: 0.4;
    transform: scale(0.85);
    filter: blur(2px);
  }

  .swiper-slide-active {
    opacity: 1;
    transform: scale(1);
    filter: blur(0);
    z-index: 10;
  }

  :global(.swiper-pagination-bullet) {
    background: white;
    opacity: 0.2;
    width: 10px;
    height: 10px;
  }
  
  :global(.swiper-pagination-bullet-active) {
    background: #D79528;
    opacity: 1;
    width: 30px;
    border-radius: 10px;
  }
</style>

<script>
  import Swiper from 'swiper';
  import { EffectCoverflow, Pagination, Autoplay } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/effect-coverflow';
  import 'swiper/css/pagination';

  // Initialize Swiper
  const initSwiper = () => {
    const swiperEl = document.querySelector('.portfolio-slider');
    if (!swiperEl) return;

    // Destroy existing instance if any
    // @ts-ignore
    if (swiperEl.swiper) {
      // @ts-ignore
      swiperEl.swiper.destroy(true, true);
    }

    new Swiper('.portfolio-slider', {
      modules: [EffectCoverflow, Pagination, Autoplay],
      effect: 'coverflow',
      grabCursor: true,
      centeredSlides: true,
      slidesPerView: 'auto',
      loop: true,
      speed: 800,
      autoplay: {
        delay: 3000,
        disableOnInteraction: false,
        pauseOnMouseEnter: true,
      },
      coverflowEffect: {
        rotate: 0,
        stretch: 0,
        depth: 150,
        modifier: 2.5,
        slideShadows: false,
      },
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      breakpoints: {
        320: {
          slidesPerView: 1.2,
          coverflowEffect: {
            depth: 50,
            modifier: 1,
          },
        },
        768: {
          slidesPerView: 'auto',
          coverflowEffect: {
            depth: 100,
            modifier: 2,
          },
        }
      }
    });
  };

  // Run on page load and view transitions
  document.addEventListener('astro:page-load', initSwiper);
  document.addEventListener('DOMContentLoaded', initSwiper);
</script>

---
import { Icon } from "astro-icon/components";
import CloudinaryImage from '../../ui/CloudinaryImage.astro';

// Project specification icons from public folder
const bathroomIcon = '/icons/projects/bathroomICONO.svg';
const bedroomIcon = '/icons/projects/bedroomICONO.svg';
const deliveryIcon = '/icons/projects/deliveryICONO.svg';
const gardenIcon = '/icons/projects/gardenICONO.svg';
const homeIcon = '/icons/projects/homeICONO.svg';
const petfriendlyIcon = '/icons/projects/petfriendlyICONO.svg';

interface SpecificationItem {
  enabled?: boolean;
  value?: number | boolean | string;
  label?: string;
  sublabel?: string;
  icon?: string;
  colorScheme?: 'primary' | 'secondary';
}

export interface Props {
  title: string;
  content?: string; // Ahora es opcional, puede venir del slot
  images?: (string | ImageMetadata)[]; // Ahora opcional
  brochureUrl?: string;
  imageCategories?: {
    name: string;
    label: string;
    images: (string | ImageMetadata)[];
  }[];
  virtualTourVideo?: string;
  specifications?: {
    bedrooms?: SpecificationItem;
    bathrooms?: SpecificationItem;
    area?: SpecificationItem;
    garden?: SpecificationItem;
    petFriendly?: SpecificationItem;
    deliveryDate?: SpecificationItem;
    customSpecs?: Array<SpecificationItem & { label: string; value: string }>;
  };
}

const { title, content = '', images = [], imageCategories, virtualTourVideo, specifications, brochureUrl } = Astro.props;

// Default specifications if not provided
const defaultSpecs = {
  bedrooms: { enabled: true, value: 3, label: 'Dormitorios', sublabel: 'Habitaciones' },
  bathrooms: { enabled: true, value: 2, label: 'Baños', sublabel: 'Completos' },
  area: { enabled: true, value: 150, label: 'm²', sublabel: 'Área construida' },
  garden: { enabled: true, value: true, label: 'Jardín', sublabel: 'Área verde privada' },
  petFriendly: { enabled: true, value: true, label: 'Pet Friendly', sublabel: 'Mascotas bienvenidas' },
  deliveryDate: { enabled: true, value: 'Julio 2025', label: 'Fecha de entrega' },
  customSpecs: []
};

const specs = specifications || defaultSpecs;

// Helper function to get image src
function getImageSrc(image: string | ImageMetadata): string {
  return typeof image === 'string' ? image : image.src;
}

// Function to organize images by category based on their path OR filename
function organizeImagesByCategory(imageList: (string | ImageMetadata)[]) {
  const categorizedImages: {
    general: (string | ImageMetadata)[],
    exterior: (string | ImageMetadata)[],
    interior: (string | ImageMetadata)[],
    planos: (string | ImageMetadata)[],
    multimedia: (string | ImageMetadata)[]
  } = {
    general: [],
    exterior: [],
    interior: [],
    planos: [],
    multimedia: []
  };

  imageList.forEach(image => {
    const src = getImageSrc(image);
    const lowerSrc = src.toLowerCase();
    
    // Extract filename without extension
    const pathParts = src.split('/');
    const filename = pathParts[pathParts.length - 1].replace(/\.(jpg|jpeg|png|webp)$/i, '').toLowerCase();
    
    // Categorize based on folder path OR filename patterns
    let categorized = false;
    let category = '';
    
    // Check folder path first
    if (lowerSrc.includes('/1. exterior/') || lowerSrc.includes('/exterior/')) {
      categorizedImages.exterior.push(image);
      category = 'exterior';
      categorized = true;
    } else if (lowerSrc.includes('/2. interior/') || lowerSrc.includes('/interior/')) {
      categorizedImages.interior.push(image);
      category = 'interior';
      categorized = true;
    } else if (lowerSrc.includes('/3. planos/') || lowerSrc.includes('/planos/')) {
      categorizedImages.planos.push(image);
      category = 'planos';
      categorized = true;
    } else if (lowerSrc.includes('/0. multimedia/') || lowerSrc.includes('/multimedia/')) {
      categorizedImages.multimedia.push(image);
      category = 'multimedia';
      categorized = true;
    }
    
    // If not categorized by folder, try by filename patterns
    if (!categorized) {
      // Planos keywords - Check first to avoid false positives
      // Match: plano, planos, planos-XX, plan, layout, blueprint, arquitectonico
      if (filename.includes('plano') || filename.includes('planos') || filename.includes('plan') || 
          filename.includes('layout') || filename.includes('blueprint') || filename.includes('arquitectonico') || 
          /planos-\d+/.test(filename) || /plano-\d+/.test(filename)) {
        categorizedImages.planos.push(image);
        category = 'planos';
        categorized = true;
      }
      // Check for explicit "exterior" in filename first (e.g., 0_Exterior_Cerramiento.webp)
      else if (filename.includes('exterior')) {
        categorizedImages.exterior.push(image);
        category = 'exterior';
        categorized = true;
      }
      // Check for explicit "interior" in filename first (e.g., 5_Interior_jardin.webp)
      else if (filename.includes('interior')) {
        categorizedImages.interior.push(image);
        category = 'interior';
        categorized = true;
      }
      // Exterior keywords - Only if "exterior" not explicitly in filename
      else if (filename.includes('vista') || filename.includes('fachada') || 
               filename.includes('entrada') || filename.includes('jardin') || filename.includes('terraza') ||
               filename.includes('area_recreacional') || filename.includes('piscina') || filename.includes('parqueadero')) {
        categorizedImages.exterior.push(image);
        category = 'exterior';
        categorized = true;
      }
      // Interior keywords - Only if "interior" not explicitly in filename - Expanded list
      else if (filename.includes('sala') || filename.includes('comedor') || filename.includes('cocina') ||
               filename.includes('habitacion') || filename.includes('dormitorio') || filename.includes('bano') ||
               filename.includes('baño') || filename.includes('escalera') || filename.includes('segundo_piso') || 
               filename.includes('piso') || filename.includes('estar') || filename.includes('living') || 
               filename.includes('estudio') || filename.includes('vestidor') || filename.includes('master') || 
               filename.includes('simple') || filename.includes('closet') || filename.includes('lavanderia') ||
               filename.includes('lavamanos') || filename.includes('coffee') || filename.includes('luz') ||
               filename.includes('habi') || filename.includes('salastar') || filename.includes('lobby') ||
               filename.includes('merchandising') || filename.includes('panoramica') || filename.includes('principal')) {
        categorizedImages.interior.push(image);
        category = 'interior';
        categorized = true;
      }
    }
    
    // Add to general category ONLY if it's exterior or interior (NOT planos or multimedia)
    if (category === 'exterior' || category === 'interior') {
      categorizedImages.general.push(image);
    }
  });

  return categorizedImages;
}

// Organize images by category
const categorizedImages = organizeImagesByCategory(images);

// Build dynamic categories array based on available images
const dynamicCategories = [];

// General always first (all images)
if (categorizedImages.general.length > 0) {
  dynamicCategories.push({
    name: 'general',
    label: 'General',
    images: categorizedImages.general
  });
}

// Add multimedia if exists
if (categorizedImages.multimedia.length > 0) {
  dynamicCategories.push({
    name: 'multimedia',
    label: 'Multimedia',
    images: categorizedImages.multimedia
  });
}

// Add exterior if exists
if (categorizedImages.exterior.length > 0) {
  dynamicCategories.push({
    name: 'exterior',
    label: 'Vista Exterior',
    images: categorizedImages.exterior
  });
}

// Add interior if exists
if (categorizedImages.interior.length > 0) {
  dynamicCategories.push({
    name: 'interior',
    label: 'Vista Interior',
    images: categorizedImages.interior
  });
}

// Add planos if exists
if (categorizedImages.planos.length > 0) {
  dynamicCategories.push({
    name: 'planos',
    label: 'Planos',
    images: categorizedImages.planos
  });
}

// Default categories if no images provided
const defaultCategories = [
  {
    name: 'general',
    label: 'General',
    images: [
      '/images/placeholder-image.png',
      '/images/placeholder-image-1.png',
      '/images/placeholder-image-2.png'
    ]
  }
];

const categories = imageCategories || (dynamicCategories.length > 0 ? dynamicCategories : defaultCategories);

// Split content into paragraphs
const paragraphs = content.split('\n\n').filter(p => p.trim());
---

<section class="py-20 bg-gradient-to-br from-gray-50 via-white to-gray-50 relative overflow-hidden project-content-section" data-categories={JSON.stringify(categories)}>
  <!-- Decorative background elements -->
  <div class="absolute top-0 left-0 w-72 h-72 bg-brand-primary/5 rounded-full blur-3xl"></div>
  <div class="absolute bottom-0 right-0 w-96 h-96 bg-brand-secondary/5 rounded-full blur-3xl"></div>

  <div class="max-w-7xl mx-auto px-6">
    <!-- Section Header -->
    <div class="text-center max-w-4xl mx-auto mb-16" data-aos="fade-up">
      <div class="inline-flex items-center gap-2 bg-brand-primary/10 backdrop-blur-sm border border-brand-primary/20 rounded-full px-4 py-2 mb-6">
        <Icon name="ph:image-square" class="w-5 h-5 text-brand-primary" />
        <span class="text-brand-primary font-semibold text-sm">Detalles del Proyecto</span>
      </div>
      
      <h2 class="text-4xl lg:text-6xl font-bold text-gray-900 leading-tight mb-6">
        {title}
      </h2>
      
      <p class="text-xl text-gray-600 leading-relaxed">
        Explora cada detalle de este proyecto y descubre la calidad en cada acabado.
      </p>
    </div>

    <!-- Main Layout Grid -->
    <div class={`grid grid-cols-1 gap-12 w-full ${specifications ? 'lg:grid-cols-3' : 'lg:grid-cols-1'} items-stretch`}>
      
      <!-- Gallery Section -->
      <div class={`bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden ${specifications ? 'lg:col-span-2' : 'lg:col-span-1'}`} data-aos="fade-right" data-aos-duration="800">
        
        <!-- Gallery Header with Category Selector -->
        <div class="bg-gradient-to-r from-gray-50 to-white p-6 border-b border-gray-100">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
              <Icon name="ph:images-fill" class="w-5 h-5 text-brand-primary" />
              Galería de Imágenes
            </h3>
            
            <!-- Category Selector -->
            <div class="flex items-center gap-3">
              <!-- Category Icon - Changes based on selection -->
              <div class="w-10 h-10 bg-gradient-to-br from-brand-primary/10 to-brand-primary/20 rounded-xl flex items-center justify-center border border-brand-primary/20">
                <div class="category-icon flex items-center justify-center w-full h-full">
                  <Icon name="ph:images-square" class="w-5 h-5 text-brand-primary" />
                </div>
              </div>
              
              <div class="relative">
                <select 
                  class="category-selector appearance-none bg-white border border-gray-200 rounded-2xl px-4 py-2 pr-10 text-sm font-medium text-gray-700 hover:border-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent transition-all duration-200 cursor-pointer shadow-sm hover:shadow-md"
                >
                  {categories.map((category, index) => (
                    <option value={category.name} selected={index === 0}>
                      {category.label}
                    </option>
                  ))}
                </select>
                
                <!-- Custom dropdown arrow -->
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                  <Icon name="ph:caret-down" class="w-4 h-4 text-gray-400" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="gallery-container relative h-[400px] lg:h-[500px] group bg-gray-50">
          {categories[0].images.map((image, index) => (
            <div 
              class={`gallery-slide absolute inset-0 transition-all duration-300 ease-in-out ${index === 0 ? 'opacity-100' : 'opacity-0'}`}
              data-slide={index}
            >
              <CloudinaryImage
                src={getImageSrc(image)}
                alt={`${title} - Imagen ${index + 1}`}
                width={1200}
                class="w-full h-full"
                loading={index === 0 ? "eager" : "lazy"}
                blur={true}
                sizes="(max-width: 768px) 100vw, 70vw"
              />
            </div>
          ))}
          
          <!-- Navigation Controls -->
          <div class="absolute inset-0 flex items-center justify-between p-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
            <button class="gallery-prev w-12 h-12 bg-white/90 backdrop-blur-sm hover:bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center pointer-events-auto">
              <Icon name="ph:caret-left" class="w-5 h-5 text-gray-900" />
            </button>
            <button class="gallery-next w-12 h-12 bg-white/90 backdrop-blur-sm hover:bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center pointer-events-auto">
              <Icon name="ph:caret-right" class="w-5 h-5 text-gray-900" />
            </button>
          </div>

          <!-- Image Counter -->
          <div class="absolute top-4 right-4 bg-gray-900/80 backdrop-blur-sm text-white px-3 py-1 rounded-2xl text-sm font-semibold shadow-lg">
            <span class="gallery-counter">1</span> / <span class="gallery-total">{categories[0].images.length}</span>
          </div>

          <!-- Category Badge -->
          <div class="absolute top-4 left-4 bg-brand-primary/90 backdrop-blur-sm text-white px-3 py-1 rounded-2xl text-sm font-semibold shadow-lg">
            <span class="category-badge">{categories[0].label}</span>
          </div>
        </div>

        <!-- Thumbnail Strip -->
        <div class="thumbnail-container p-6 border-t border-gray-100 overflow-hidden">
          <div class="relative w-full">
            <!-- Scroll Navigation Buttons -->
            <button 
              class="scroll-left-btn absolute left-0 top-1/2 transform -translate-y-1/2 -translate-x-2 z-20 w-8 h-8 bg-white/90 backdrop-blur-sm hover:bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center opacity-1 pointer-events-auto"
            >
              <Icon name="ph:caret-left" class="w-4 h-4 text-gray-900" />
            </button>
            
            <button 
              class="scroll-right-btn absolute right-0 top-1/2 transform -translate-y-1/2 translate-x-2 z-20 w-8 h-8 bg-white/90 backdrop-blur-sm hover:bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center opacity-1 pointer-events-auto"
            >
              <Icon name="ph:caret-right" class="w-4 h-4 text-gray-900" />
            </button>

            <!-- Scrollable Container -->
            <div 
              class="thumbnail-scroll-container overflow-x-auto scrollbar-hide scroll-smooth"
              style="scrollbar-width: none; -ms-overflow-style: none; width: 100%;"
            >
              <div class="thumbnail-grid flex gap-4 p-4" style="width: fit-content; min-width: 100%;">
                {categories[0].images.map((image, index) => (
                  <button 
                    class={`gallery-thumb flex-shrink-0 w-32 h-20 rounded-2xl overflow-hidden transition-all duration-300 shadow-md hover:shadow-lg ${index === 0 ? 'ring-2 ring-brand-primary' : 'ring-1 ring-gray-200 hover:ring-brand-primary/50'}`}
                    data-slide={index}
                  >
                    <CloudinaryImage
                      src={getImageSrc(image)}
                      alt={`Thumbnail ${index + 1}`}
                      width={200}
                      class="w-full h-full"
                      loading="lazy"
                      blur={false}
                    />
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Info Column -->
      <div class="h-full" data-aos="fade-left" data-aos-duration="800" data-aos-delay="200">
        <!-- Project Stats Card -->
        {specifications && (
        <div class="bg-white rounded-3xl shadow-2xl border border-gray-100 p-8">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-12 h-12 bg-gradient-to-br from-brand-primary to-brand-primary/80 rounded-2xl flex items-center justify-center">
              <Icon name="ph:chart-bar-fill" class="w-6 h-6 text-white" />
            </div>
            <h3 class="text-2xl font-bold text-gray-900">Especificaciones</h3>
          </div>
          
          <div class="space-y-4 max-h-[400px] overflow-y-auto pr-2 specs-scroll-area">
            <!-- Bedrooms -->
            {specs.bedrooms?.enabled && (
              <div class="bg-gradient-to-br from-brand-secondary/10 to-brand-secondary/20 rounded-2xl p-4 border border-brand-secondary/30">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center border-2 border-brand-secondary">
                    <img src={bedroomIcon} alt={specs.bedrooms.label || 'Dormitorios'} class="w-7 h-7" />
                  </div>
                  <div>
                    <div class="text-xl font-bold text-gray-900">{specs.bedrooms.value} {specs.bedrooms.label || 'Dormitorios'}</div>
                    {specs.bedrooms.sublabel && <div class="text-sm text-gray-600">{specs.bedrooms.sublabel}</div>}
                  </div>
                </div>
              </div>
            )}

            <!-- Bathrooms -->
            {specs.bathrooms?.enabled && (
              <div class="bg-gradient-to-br from-brand-primary/10 to-brand-primary/20 rounded-2xl p-4 border border-brand-primary/30">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center border-2 border-brand-primary">
                    <img src={bathroomIcon} alt={specs.bathrooms.label || 'Baños'} class="w-7 h-7" />
                  </div>
                  <div>
                    <div class="text-xl font-bold text-gray-900">{specs.bathrooms.value} {specs.bathrooms.label || 'Baños'}</div>
                    {specs.bathrooms.sublabel && <div class="text-sm text-gray-600">{specs.bathrooms.sublabel}</div>}
                  </div>
                </div>
              </div>
            )}

            <!-- Area -->
            {specs.area?.enabled && (
              <div class="bg-gradient-to-br from-brand-secondary/15 to-brand-secondary/25 rounded-2xl p-4 border border-brand-secondary/40">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center border-2 border-brand-secondary">
                    <img src={homeIcon} alt="Área" class="w-7 h-7" />
                  </div>
                  <div>
                    <div class="text-xl font-bold text-gray-900">{specs.area.value} {specs.area.label || 'm²'}</div>
                    {specs.area.sublabel && <div class="text-sm text-gray-600">{specs.area.sublabel}</div>}
                  </div>
                </div>
              </div>
            )}

            <!-- Garden -->
            {specs.garden?.enabled && specs.garden.value && (
              <div class="bg-gradient-to-br from-brand-primary/15 to-brand-primary/25 rounded-2xl p-4 border border-brand-primary/40">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center border-2 border-brand-primary">
                    <img src={gardenIcon} alt={specs.garden.label || 'Jardín'} class="w-7 h-7" />
                  </div>
                  <div>
                    <div class="text-xl font-bold text-gray-900">{specs.garden.label || 'Jardín'}</div>
                    {specs.garden.sublabel && <div class="text-sm text-gray-600">{specs.garden.sublabel}</div>}
                  </div>
                </div>
              </div>
            )}

            <!-- Pet Friendly -->
            {specs.petFriendly?.enabled && specs.petFriendly.value && (
              <div class="bg-gradient-to-br from-brand-secondary/10 to-brand-secondary/20 rounded-2xl p-4 border border-brand-secondary/30">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center border-2 border-brand-secondary">
                    <img src={petfriendlyIcon} alt={specs.petFriendly.label || 'Pet Friendly'} class="w-7 h-7" />
                  </div>
                  <div>
                    <div class="text-xl font-bold text-gray-900">{specs.petFriendly.label || 'Pet Friendly'}</div>
                    {specs.petFriendly.sublabel && <div class="text-sm text-gray-600">{specs.petFriendly.sublabel}</div>}
                  </div>
                </div>
              </div>
            )}
            
            <!-- Custom Specifications -->
            {specs.customSpecs?.map((customSpec, index) => (
              customSpec.enabled && (
                <div class={`bg-gradient-to-br ${customSpec.colorScheme === 'secondary' ? 'from-brand-secondary/10 to-brand-secondary/20 border-brand-secondary/30' : 'from-brand-primary/10 to-brand-primary/20 border-brand-primary/30'} rounded-2xl p-4 border`}>
                  <div class="flex items-center gap-3">
                    <div class={`w-12 h-12 bg-white rounded-xl flex items-center justify-center border-2 ${customSpec.colorScheme === 'secondary' ? 'border-brand-secondary' : 'border-brand-primary'}`}>
                      <Icon name={customSpec.icon || 'ph:check-circle'} class="w-7 h-7" />
                    </div>
                    <div>
                      <div class="text-xl font-bold text-gray-900">{customSpec.value}</div>
                      {customSpec.sublabel && <div class="text-sm text-gray-600">{customSpec.sublabel}</div>}
                    </div>
                  </div>
                </div>
              )
            ))}

            <!-- Completion Date (Inside Scroll) -->
            {specs.deliveryDate?.enabled && (
              <div class="mt-2 bg-gradient-to-r from-gray-50 to-gray-100 rounded-2xl p-4 border border-gray-200">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center border-2 border-brand-primary">
                    <img src={deliveryIcon} alt="Entrega" class="w-7 h-7" />
                  </div>
                  <div>
                    <div class="text-xl font-bold text-gray-900">{specs.deliveryDate.value || 'Julio 2025'}</div>
                    <div class="text-gray-600">{specs.deliveryDate.label || 'Fecha de entrega'}</div>
                  </div>
                </div>
              </div>
            )}
          </div>

          <!-- Action Buttons Footer -->
          <div class="mt-8 pt-6 border-t border-gray-200">
            <div class="grid grid-cols-3 gap-2">
              <div class="text-center">
                <a 
                  href={brochureUrl || "#"} 
                  target={brochureUrl ? "_blank" : "_self"} 
                  download={!!brochureUrl}
                  class={`w-full flex flex-col items-center gap-2 p-4 rounded-2xl bg-white hover:bg-gray-50 border border-gray-200 hover:border-brand-primary/30 transition-all duration-300 group ${!brochureUrl ? 'opacity-50 cursor-not-allowed pointer-events-none' : ''}`}
                >
                  <div class="w-12 h-12 bg-gray-100 group-hover:bg-brand-primary/10 rounded-xl flex items-center justify-center transition-colors duration-300">
                    <Icon name="ph:download" class="w-6 h-6 text-gray-600 group-hover:text-brand-primary" />
                  </div>
                  <span class="text-sm font-medium text-gray-700 group-hover:text-brand-primary">Descargar Brochure</span>
                </a>
              </div>
              
              <div class="text-center">
                <button 
                  id="virtualTourBtn"
                  class="virtual-tour-btn w-full flex flex-col items-center gap-2 p-4 rounded-2xl bg-white hover:bg-gray-50 border border-gray-200 hover:border-brand-primary/30 transition-all duration-300 group"
                  data-video-url={virtualTourVideo}
                  disabled={!virtualTourVideo}
                  style={!virtualTourVideo ? 'opacity: 0.5; cursor: not-allowed;' : ''}
                >
                  <div class="w-12 h-12 bg-gray-100 group-hover:bg-brand-primary/10 rounded-xl flex items-center justify-center transition-colors duration-300">
                    <Icon name="ph:video" class="w-6 h-6 text-gray-600 group-hover:text-brand-primary" />
                  </div>
                  <span class="text-sm font-medium text-gray-700 group-hover:text-brand-primary">Tour Virtual</span>
                </button>
              </div>
              
              <div class="text-center">
                <a href={`https://wa.me/593998323304?text=%C2%A1Hola%20Carpio%20Constructora!%20%F0%9F%A4%A9%20Me%20encantar%C3%ADa%20conocer%20m%C3%A1s%20sobre%20${encodeURIComponent(title)}.%20%C2%BFPodr%C3%ADan%20enviarme%20m%C3%A1s%20informaci%C3%B3n%3F`} target="_blank" class="w-full flex flex-col items-center gap-2 p-4 rounded-2xl bg-white hover:bg-gray-50 border border-gray-200 hover:border-brand-primary/30 transition-all duration-300 group">
                  <div class="w-12 h-12 bg-gray-100 group-hover:bg-brand-primary/10 rounded-xl flex items-center justify-center transition-colors duration-300">
                    <Icon name="ph:whatsapp-logo-fill" class="w-6 h-6 text-gray-600 group-hover:text-brand-primary" />
                  </div>
                  <span class="text-sm font-medium text-gray-700 group-hover:text-brand-primary">Más información</span>
                </a>
              </div>
            </div>
          </div>
        </div>
        )}
      </div>
    </div>
  </div>

  <!-- Video Modal -->
  <div class="video-modal fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="relative w-full max-w-5xl bg-gray-900 rounded-3xl overflow-hidden shadow-2xl">
      <!-- Close Button -->
      <button 
        class="close-video-modal absolute top-4 right-4 z-10 w-12 h-12 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center transition-all duration-300 group"
      >
        <Icon name="ph:x" class="w-6 h-6 text-white" />
      </button>
      
      <!-- Video Container -->
      <div class="relative w-full" style="padding-bottom: 56.25%;">
        <video 
          class="virtual-tour-video absolute inset-0 w-full h-full"
          controls
          controlslist="nodownload"
          preload="metadata"
        >
          Tu navegador no soporta el elemento de video.
        </video>
      </div>
    </div>
  </div>
</section>

<!-- Scoped Script -->
<script>
  interface CategoryImage {
    src?: string;
    [key: string]: any;
  }

  interface Category {
    name: string;
    label: string;
    images: (string | CategoryImage)[];
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Select all project content sections
    const projectSections = document.querySelectorAll('.project-content-section');

    projectSections.forEach(section => {
      // Get categories data from data attribute
      const categoriesData = section.getAttribute('data-categories');
      if (!categoriesData) return;

      let categories: Category[];
      try {
        categories = JSON.parse(categoriesData);
      } catch (e) {
        console.error('Error parsing categories data:', e);
        return;
      }
      
      // Select elements within this specific section
      const categorySelector = section.querySelector('.category-selector') as HTMLSelectElement | null;
      const categoryIcon = section.querySelector('.category-icon') as HTMLElement | null;
      const galleryContainer = section.querySelector('.gallery-container') as HTMLElement | null;
      const prevButton = section.querySelector('.gallery-prev') as HTMLButtonElement | null;
      const nextButton = section.querySelector('.gallery-next') as HTMLButtonElement | null;
      const galleryCounter = section.querySelector('.gallery-counter') as HTMLElement | null;
      const galleryTotal = section.querySelector('.gallery-total') as HTMLElement | null;
      const categoryBadge = section.querySelector('.category-badge') as HTMLElement | null;
      const thumbnailGrid = section.querySelector('.thumbnail-grid') as HTMLElement | null;
      const thumbnailScrollContainer = section.querySelector('.thumbnail-scroll-container') as HTMLElement | null;
      const scrollLeftBtn = section.querySelector('.scroll-left-btn') as HTMLButtonElement | null;
      const scrollRightBtn = section.querySelector('.scroll-right-btn') as HTMLButtonElement | null;
      
      // Video Modal Elements - Scoped to section
      const videoModal = section.querySelector('.video-modal') as HTMLElement | null;
      const closeVideoModal = section.querySelector('.close-video-modal') as HTMLButtonElement | null;
      const virtualTourVideo = section.querySelector('.virtual-tour-video') as HTMLVideoElement | null;
      const virtualTourBtns = section.querySelectorAll('.virtual-tour-btn') as NodeListOf<HTMLButtonElement>; 
      
      let currentSlide = 0;
      let currentCategory = categories[0];

      // Initialize
      if (currentCategory) {
          updateCategoryIcon(currentCategory.name);
      }

      function updateCategoryIcon(categoryName: string) {
        if (!categoryIcon) return;
        
        const iconMap: Record<string, string> = {
          'general': `<svg class="w-5 h-5 text-brand-primary" fill="currentColor" viewBox="0 0 256 256"><path d="M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40ZM40,56H216V200H40ZM144,88a8,8,0,0,1,8-8h64a8,8,0,0,1,0,16H152A8,8,0,0,1,144,88Zm0,32a8,8,0,0,1,8-8h64a8,8,0,0,1,0,16H152A8,8,0,0,1,144,120Zm0,32a8,8,0,0,1,8-8h64a8,8,0,0,1,0,16H152A8,8,0,0,1,144,152ZM112,88v80a8,8,0,0,1-16,0V96L89.66,102.34a8,8,0,0,1-11.32-11.32l16-16A8,8,0,0,1,112,88Z"></path></svg>`,
          'exterior': `<svg class="w-5 h-5 text-brand-primary" fill="currentColor" viewBox="0 0 256 256"><path d="M240,208H224V96a16,16,0,0,0-16-16H164.94L139.58,51.58A16,16,0,0,0,128,48H48A16,16,0,0,0,32,64V208H16a8,8,0,0,0,0,16H240a8,8,0,0,0,0-16ZM208,80V208H48V64H128l26.42,32Z"></path></svg>`,
          'interior': `<svg class="w-5 h-5 text-brand-primary" fill="currentColor" viewBox="0 0 256 256"><path d="M219.31,108.68l-80-80a16,16,0,0,0-22.62,0l-80,80A15.87,15.87,0,0,0,32,120v96a8,8,0,0,0,8,8H216a8,8,0,0,0,8-8V120A15.87,15.87,0,0,0,219.31,108.68ZM208,208H48V120l80-80,80,80Z"></path></svg>`,
          'planos': `<svg class="w-5 h-5 text-brand-primary" fill="currentColor" viewBox="0 0 256 256"><path d="M232,48V208a8,8,0,0,1-8,8H32a8,8,0,0,1-8-8V48a8,8,0,0,1,8-8H224A8,8,0,0,1,232,48ZM216,56H40V200H216ZM88,88V176a8,8,0,0,1-16,0V107.31L60.69,118.63a8,8,0,0,1-11.32-11.32l24-24A8,8,0,0,1,88,88Zm136,0a8,8,0,0,1-8,8H160a8,8,0,0,1,0-16h56A8,8,0,0,1,224,88Zm0,32a8,8,0,0,1-8,8H160a8,8,0,0,1,0-16h56A8,8,0,0,1,224,120Zm0,32a8,8,0,0,1-8,8H160a8,8,0,0,1,0-16h56A8,8,0,0,1,224,152Z"></path></svg>`
        };
        
        const iconSvg = iconMap[categoryName] || iconMap['general'];
        categoryIcon.innerHTML = iconSvg;
      }

      function updateSlide(index: number, skipScroll: boolean = false) {
        if (!currentCategory || !currentCategory.images || index < 0 || index >= currentCategory.images.length) return;
        
        // Update slides
        if (galleryContainer) {
          const slides = galleryContainer.querySelectorAll('.gallery-slide');
          slides.forEach((slide, i) => {
            slide.classList.toggle('opacity-100', i === index);
            slide.classList.toggle('opacity-0', i !== index);
          });
        }
        
        // Update thumbnails
        if (thumbnailGrid) {
          const thumbs = thumbnailGrid.querySelectorAll('.gallery-thumb');
          thumbs.forEach((thumb, i) => {
            if (i === index) {
              thumb.classList.remove('ring-1', 'ring-gray-200', 'hover:ring-brand-primary/50');
              thumb.classList.add('ring-2', 'ring-brand-primary');
              // Scroll thumbnail into view only if not skipping (e.g. init)
              if (!skipScroll) {
                try {
                  thumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } catch(e) { /* ignore */ }
              }
            } else {
              thumb.classList.remove('ring-2', 'ring-brand-primary');
              thumb.classList.add('ring-1', 'ring-gray-200', 'hover:ring-brand-primary/50');
            }
          });
        }
        
        // Update counter
        if (galleryCounter) {
          galleryCounter.textContent = (index + 1).toString();
        }
        
        currentSlide = index;
      }

      function nextSlide() {
        if (!currentCategory || !currentCategory.images) return;
        updateSlide((currentSlide + 1) % currentCategory.images.length);
      }
      
      function prevSlide() {
        if (!currentCategory || !currentCategory.images) return;
        updateSlide((currentSlide - 1 + currentCategory.images.length) % currentCategory.images.length);
      }

      // Event Listeners
      if (prevButton) prevButton.addEventListener('click', prevSlide);
      if (nextButton) nextButton.addEventListener('click', nextSlide);

      if (categorySelector) {
        categorySelector.addEventListener('change', (e) => {
          const target = e.target as HTMLSelectElement;
          updateGalleryContent(target.value);
        });
      }

      // Thumbnail Scroll Controls
      if (scrollLeftBtn && thumbnailScrollContainer) {
        scrollLeftBtn.addEventListener('click', () => {
          thumbnailScrollContainer.scrollBy({ left: -200, behavior: 'smooth' });
        });
      }
      
      if (scrollRightBtn && thumbnailScrollContainer) {
        scrollRightBtn.addEventListener('click', () => {
          thumbnailScrollContainer.scrollBy({ left: 200, behavior: 'smooth' });
        });
      }

      // Video Modal Controls
      if (virtualTourBtns.length > 0 && videoModal && virtualTourVideo) {
        virtualTourBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const videoUrl = btn.getAttribute('data-video-url');
            if (videoUrl) {
              virtualTourVideo.src = videoUrl;
              videoModal.classList.remove('hidden');
              videoModal.classList.add('flex');
              virtualTourVideo.play().catch(e => console.log('Autoplay prevented:', e));
            }
          });
        });
        
        const closeModal = () => {
          videoModal.classList.add('hidden');
          videoModal.classList.remove('flex');
          virtualTourVideo.pause();
          virtualTourVideo.currentTime = 0;
        };
        
        if (closeVideoModal) closeVideoModal.addEventListener('click', closeModal);
        
        // Close on click outside
        videoModal.addEventListener('click', (e) => {
          if (e.target === videoModal) {
            closeModal();
          }
        });
      }

      function getImageSrc(image: string | CategoryImage): string {
        if (typeof image === 'string') {
          return image;
        }
        return image.src || '';
      }

      function updateGalleryContent(categoryName: string) {
        const category = categories.find((cat) => cat.name === categoryName);
        if (!category) return;

        currentCategory = category;
        currentSlide = 0;

        // Update gallery slides
        if (galleryContainer) {
          // Remove existing slides
          const existingSlides = galleryContainer.querySelectorAll('.gallery-slide');
          existingSlides.forEach(slide => slide.remove());
          
          // Add new slides
          category.images.forEach((image, index) => {
            const slideDiv = document.createElement('div');
            slideDiv.className = `gallery-slide absolute inset-0 transition-all duration-300 ease-in-out ${index === 0 ? 'opacity-100' : 'opacity-0'}`;
            slideDiv.setAttribute('data-slide', index.toString());
            
            const img = document.createElement('img');
            img.src = getImageSrc(image);
            img.alt = `Imagen ${index + 1}`;
            img.className = 'w-full h-full object-cover';
            
            slideDiv.appendChild(img);
            galleryContainer.insertBefore(slideDiv, galleryContainer.firstChild);
          });
        }

        // Update thumbnails
        if (thumbnailGrid) {
          // Clear existing thumbnails
          thumbnailGrid.innerHTML = '';
          
          // Add new thumbnails
          category.images.forEach((image, index) => {
            const thumbButton = document.createElement('button');
            thumbButton.className = `gallery-thumb flex-shrink-0 w-32 h-20 rounded-2xl overflow-hidden transition-all duration-300 shadow-md hover:shadow-lg ${index === 0 ? 'ring-2 ring-brand-primary' : 'ring-1 ring-gray-200 hover:ring-brand-primary/50'}`;
            thumbButton.setAttribute('data-slide', index.toString());
            
            const img = document.createElement('img');
            img.src = getImageSrc(image);
            img.alt = `Thumbnail ${index + 1}`;
            img.className = 'w-full h-full object-cover';
            
            thumbButton.appendChild(img);
            thumbButton.addEventListener('click', () => updateSlide(index));
            
            thumbnailGrid.appendChild(thumbButton);
          });
          
          // Force the container to expand
          thumbnailGrid.style.width = 'fit-content';
          thumbnailGrid.style.minWidth = '100%';
        }

        // Update total count
        if (galleryTotal) {
          galleryTotal.textContent = category.images.length.toString();
        }

        // Update category badge
        if (categoryBadge) {
          categoryBadge.textContent = category.label;
        }

        // Update category icon
        updateCategoryIcon(categoryName);

        // Reset counter to 1
        if (galleryCounter) {
          galleryCounter.textContent = '1';
        }
        
        // Initial init for new setup
        updateSlide(0, true);
      }
      
      // Initial Setup
      updateSlide(0, true);
      
    }); // End forEach project section
  });
</script>

<style>
  .thumbnail-scroll-container {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  
  .thumbnail-scroll-container::-webkit-scrollbar {
    display: none;
  }
  
  .thumbnail-grid {
    width: fit-content !important;
    min-width: 100%;
  }
  
  .gallery-thumb {
    min-width: 128px;
  }

  /* Specifications scroll area */
  .specs-scroll-area {
    scrollbar-width: thin;
    scrollbar-color: rgba(16, 54, 70, 0.3) transparent;
  }
  
  .specs-scroll-area::-webkit-scrollbar {
    width: 6px;
  }
  
  .specs-scroll-area::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .specs-scroll-area::-webkit-scrollbar-thumb {
    background: rgba(16, 54, 70, 0.3);
    border-radius: 3px;
  }
  
  .specs-scroll-area::-webkit-scrollbar-thumb:hover {
    background: rgba(16, 54, 70, 0.5);
  }
</style>
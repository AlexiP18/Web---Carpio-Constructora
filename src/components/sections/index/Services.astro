---
import { Icon } from 'astro-icon/components';
import SectionLayout from '../../ui/SectionLayout.astro';

// Data: services list with images and details
const services = [
  {
    id: 'proyectos-industriales',
    number: '01',
    title: 'Construcciones',
    icon: 'ph:factory',
    description:
      'Diseñamos y ejecutamos proyectos industriales con enfoque en eficiencia, seguridad y estándares de calidad.',
    href: '/servicios/construccion',
    cta: 'Ver más',
    images: ['/images/header-30.png', '/images/header-50.png', '/images/layout-355.png']
  },
  {
    id: 'centros-logisticos',
    number: '02',
    title: 'Renovaciones',
    icon: 'ph:warehouse',
    description:
      'Soluciones a la medida para cadenas logísticas: capacidad, flujo y seguridad operativa.',
    href: '/servicios/remodelacion',
    cta: 'Ver más',
    images: ['/images/layout-85.png', '/images/header-30.png', '/images/header-50.png']
  },
  {
    id: 'planimetria',
    number: '03',
    title: 'Planimetría',
    icon: 'ph:ruler',
    description:
      'Levantamientos y planos detallados para una ejecución sin sorpresas y con total precisión.',
    href: '/servicios/mantenimiento',
    cta: 'Ver más',
    images: ['/images/layout-355.png', '/images/layout-85.png', '/images/header-30.png']
  },
  {
    id: 'oficinas-industriales',
    number: '04',
    title: 'Asesorías',
    icon: 'ph:buildings',
    description:
      'Espacios corporativos funcionales y modernos integrados a complejos industriales.',
    href: '/servicios/construccion',
    cta: 'Ver más',
    images: ['/images/header-50.png', '/images/layout-355.png', '/images/layout-85.png']
  }
];
---

<SectionLayout background="white" paddingY="lg" paddingX="lg" maxWidth="xl" className="relative overflow-hidden">
  <div data-services-vertical class="vertical-services">
    <div class="vertical-services__track">
      <div aria-hidden="true" class="vertical-services__pad vertical-services__pad--intro"></div>

      <div data-services-stage class="vertical-services__stage">
        <div class="vertical-services__layout flex flex-col lg:flex-row lg:items-start gap-8 lg:gap-14">
          <div class="vertical-services__headline" role="group" aria-live="polite">
            {services.map((s, idx) => (
              <article
                data-service-headline
                data-service-index={idx}
                class={`vertical-services__headline-item ${idx === 0 ? 'is-active' : 'hidden'}`}
                aria-hidden={idx === 0 ? 'false' : 'true'}
              >
                <div class="vertical-services__headline-card">
                  <span class="vertical-services__headline-number">{s.number}</span>
                  <span class="vertical-services__headline-title">{s.title}</span>
                </div>
              </article>
            ))}
          </div>

          <div data-service-panels class="vertical-services__panels flex-1 space-y-6">
            {services.map((s, idx) => (
              <article
                id={`service-panel-${s.id}`}
                role="group"
                aria-hidden={idx === 0 ? 'false' : 'true'}
                data-service-panel
                data-service-index={idx}
                class={`vertical-services__panel grid gap-6 lg:gap-10 lg:grid-cols-[minmax(0,360px)_minmax(0,1fr)] items-start rounded-3xl border border-neutral-darkest/10 bg-white/70 p-6 lg:p-10 shadow-[0_24px_60px_rgba(15,23,42,0.08)] backdrop-blur ${idx === 0 ? 'is-active' : 'hidden'}`}
              >
                <div class="vertical-services__panel-copy space-y-5 text-neutral-darkest">
                  <div class="flex items-center gap-4">
                    <Icon name={s.icon} class="w-6 h-6 lg:w-7 lg:h-7 text-neutral-darkest" />
                    <div>
                      <p class="font-urbanist text-sm uppercase tracking-[0.35em] text-neutral-darkest/60">{s.number}</p>
                      <h3 class="font-urbanist font-semibold text-2xl lg:text-4xl leading-tight">{s.title}</h3>
                    </div>
                  </div>
                  <p class="font-heebo text-base lg:text-lg text-neutral-darkest/80 leading-relaxed">
                    {s.description}
                  </p>
                  <a
                    href={s.href}
                    class="inline-flex items-center justify-center w-fit mt-2 px-5 py-2.5 rounded-full border-2 border-neutral-darkest text-neutral-darkest font-medium transition-colors hover:bg-neutral-darkest hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-neutral-darkest focus-visible:ring-offset-2"
                  >
                    {s.cta}
                    <Icon name="ph:arrow-right" class="w-5 h-5 ml-2" />
                  </a>
                </div>
                <div class="vertical-services__panel-media">
                  <div class="grid grid-cols-2 grid-rows-3 gap-3 lg:gap-4 h-[300px] lg:h-[520px]">
                    <div class="col-span-2 row-span-1 rounded-xl overflow-hidden border border-neutral-darkest/15">
                      <img src={s.images[0]} alt={s.title} class="w-full h-full object-cover" loading="lazy" />
                    </div>
                    <div class="col-span-1 row-span-1 rounded-xl overflow-hidden border border-neutral-darkest/15">
                      <img src={s.images[1]} alt={s.title} class="w-full h-full object-cover" loading="lazy" />
                    </div>
                    <div class="col-span-1 row-span-2 rounded-xl overflow-hidden border border-neutral-darkest/15">
                      <img src={s.images[2]} alt={s.title} class="w-full h-full object-cover" loading="lazy" />
                    </div>
                    <div class="col-span-1 row-span-1 hidden lg:block"></div>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </div>
      </div>

      <div aria-hidden="true" class="vertical-services__scroll-steps">
        {services.map((_, idx) => (
          <div
            class="vertical-services__scroll-step"
            data-scroll-step
            data-scroll-index={idx}
          ></div>
        ))}
      </div>

      <div aria-hidden="true" class="vertical-services__pad vertical-services__pad--outro"></div>
    </div>
  </div>

  <script is:inline>
    function initServicesVertical() {
      const root = document.querySelector('[data-services-vertical]');
      if (!root) return;

      const headlineItems = Array.from(root.querySelectorAll('[data-service-headline]'));
      const panels = Array.from(root.querySelectorAll('[data-service-panel]'));
      const scrollSteps = Array.from(root.querySelectorAll('[data-scroll-step]'));
      const stage = root.querySelector('[data-services-stage]');

      if (!headlineItems.length || !panels.length) return;

      const total = panels.length;

      const TRANSITION_MS = 650;
      let current = 0;
      let isAnimating = false;
      let pending = null;

      function setActiveState(list, idx) {
        list.forEach((node, i) => {
          const active = i === idx;
          node.classList.toggle('is-active', active);
          node.classList.toggle('hidden', !active);
          if (node.hasAttribute('aria-hidden')) {
            node.setAttribute('aria-hidden', String(!active));
          }
        });
      }

      function updateDisplay(idx) {
        if (idx < 0 || idx >= total) return;
        setActiveState(headlineItems, idx);
        setActiveState(panels, idx);
        current = idx;
      }

      function requestActivation(idx, options = {}) {
        if (idx === current || idx < 0 || idx >= total) {
          return;
        }

        if (options.immediate) {
          isAnimating = false;
          pending = null;
          updateDisplay(idx);
          return;
        }

        if (isAnimating) {
          pending = { idx, options };
          return;
        }

        isAnimating = true;
        stage?.classList.add('is-animating');
        updateDisplay(idx);

        window.setTimeout(() => {
          isAnimating = false;
          stage?.classList.remove('is-animating');

          if (pending && pending.idx !== current) {
            const next = pending;
            pending = null;
            requestActivation(next.idx, next.options);
          } else {
            pending = null;
          }
        }, TRANSITION_MS);
      }

      function goToPrevious() {
        const target = (current - 1 + total) % total;
        requestActivation(target);
      }

      function goToNext() {
        const target = (current + 1) % total;
        requestActivation(target);
      }

      if (scrollSteps.length) {
        const observer = new IntersectionObserver(
          (entries) => {
            entries
              .filter((entry) => entry.isIntersecting)
              .sort((a, b) => b.intersectionRatio - a.intersectionRatio)
              .forEach((entry) => {
                const indexAttr = entry.target.getAttribute('data-scroll-index');
                const idx = indexAttr ? Number.parseInt(indexAttr, 10) : NaN;
                if (!Number.isNaN(idx)) {
                  requestActivation(idx);
                }
              });
          },
          {
            threshold: 0.6,
            rootMargin: '0px 0px -20% 0px'
          }
        );

        scrollSteps.forEach((step) => observer.observe(step));
      }

      updateDisplay(current);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initServicesVertical, { once: true });
    } else {
      initServicesVertical();
    }
  </script>
</SectionLayout>

<style>
  .vertical-services {
    position: relative;
  }

  .vertical-services__track {
    position: relative;
    display: block;
  }

  .vertical-services__pad {
    width: 100%;
    pointer-events: none;
  }

  .vertical-services__pad--intro {
    height: clamp(18vh, 12rem, 22vh);
  }

  .vertical-services__pad--outro {
    height: clamp(24vh, 18rem, 34vh);
  }

  .vertical-services__stage {
    position: sticky;
    top: clamp(3.5rem, 10vh, 6rem);
    z-index: 2;
    width: 100%;
    transition: transform 0.45s ease, box-shadow 0.45s ease;
    will-change: transform;
  }

  @media (max-width: 1023px) {
    .vertical-services__stage {
      top: clamp(1.5rem, 8vh, 3rem);
    }
  }

  .vertical-services__stage.is-animating {
    transform: translateY(-6px);
  }

  .vertical-services__stage.is-animating .vertical-services__tab {
    pointer-events: none;
  }

  .vertical-services__layout {
    height: 100%;
  }

  @media (min-width: 1024px) {
    .vertical-services__layout {
      display: grid;
      grid-template-columns: clamp(160px, 18vw, 220px) minmax(0, 1fr);
      align-items: stretch;
    }
  }

  .vertical-services__scroll-steps {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: clamp(14vh, 12vw, 24vh);
    padding-block: clamp(8vh, 6vw, 12vh);
    pointer-events: none;
  }

  .vertical-services__scroll-step {
    width: 100%;
    height: max(68vh, 520px);
  }

  .vertical-services__headline {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: clamp(2rem, 4vw, 3rem);
    max-width: clamp(160px, 18vw, 220px);
    margin-inline: auto;
  }

  @media (min-width: 1024px) {
    .vertical-services__headline {
      height: 100%;
    }
  }

  .vertical-services__headline-card {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: clamp(2rem, 3.5vw, 2.8rem);
    padding: clamp(2.5rem, 6vw, 3.75rem) clamp(1.75rem, 4vw, 2.25rem);
    border-radius: 999px;
    background: linear-gradient(180deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.78));
    color: #f8fafc;
    border: 1px solid rgba(248, 250, 252, 0.08);
    box-shadow: 0 28px 70px rgba(15, 23, 42, 0.38);
    min-height: clamp(320px, 48vh, 520px);
    width: 100%;
  }

  @media (min-width: 1024px) {
    .vertical-services__headline-card {
      height: 100%;
    }
  }

  .vertical-services__headline-number {
    font-family: 'Urbanist', sans-serif;
    font-size: clamp(1.25rem, 2.2vw, 1.6rem);
    font-weight: 600;
    letter-spacing: 0.45em;
    text-transform: uppercase;
    color: rgba(248, 250, 252, 0.7);
  }

  .vertical-services__headline-title {
    display: inline-flex;
    font-family: 'Urbanist', sans-serif;
    font-weight: 600;
    font-size: clamp(1.05rem, 1.9vw, 1.45rem);
    line-height: 1.4;
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    letter-spacing: 0.35em;
    text-transform: uppercase;
    color: rgba(248, 250, 252, 0.92);
    text-align: center;
  }

  .vertical-services__headline-item.is-active .vertical-services__headline-card {
    animation: headline-fade 0.55s ease forwards;
  }

  @media (max-width: 1023px) {
    .vertical-services__headline {
      max-width: 220px;
    }
  }

  .vertical-services__panel {
    background: rgba(255, 255, 255, 0.78);
    border-radius: 1.75rem;
  }

  @media (min-width: 1024px) {
    .vertical-services__panels,
    .vertical-services__panel {
      height: 100%;
    }
  }

  .vertical-services__panel.is-active {
    animation: fade-in-up 0.45s ease forwards;
  }

  @keyframes headline-fade {
    from {
      opacity: 0;
      transform: translateY(12px) scale(0.99);
    }

    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes fade-in-up {
    from {
      opacity: 0;
      transform: translateY(24px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

---
import { Icon } from 'astro-icon/components';
import SectionLayout from '../../ui/SectionLayout.astro';

// Data: services list with images and details
const services = [
  {
    id: 'proyectos-industriales',
    number: '01',
    title: 'Proyectos y Construcciones Industriales',
    icon: 'ph:factory',
    description:
      'Diseñamos y ejecutamos proyectos industriales con enfoque en eficiencia, seguridad y estándares de calidad.',
    href: '/servicios/construccion',
    cta: 'Ver más',
    images: ['/images/header-30.png', '/images/header-50.png', '/images/layout-355.png']
  },
  {
    id: 'centros-logisticos',
    number: '02',
    title: 'Centros de Distribución Logística',
    icon: 'ph:warehouse',
    description:
      'Soluciones a la medida para cadenas logísticas: capacidad, flujo y seguridad operativa.',
    href: '/servicios/remodelacion',
    cta: 'Ver más',
    images: ['/images/layout-85.png', '/images/header-30.png', '/images/header-50.png']
  },
  {
    id: 'planimetria',
    number: '03',
    title: 'Planimetría',
    icon: 'ph:ruler',
    description:
      'Levantamientos y planos detallados para una ejecución sin sorpresas y con total precisión.',
    href: '/servicios/mantenimiento',
    cta: 'Ver más',
    images: ['/images/layout-355.png', '/images/layout-85.png', '/images/header-30.png']
  },
  {
    id: 'oficinas-industriales',
    number: '04',
    title: 'Oficinas para Complejos Industriales',
    icon: 'ph:buildings',
    description:
      'Espacios corporativos funcionales y modernos integrados a complejos industriales.',
    href: '/servicios/construccion',
    cta: 'Ver más',
    images: ['/images/header-50.png', '/images/layout-355.png', '/images/layout-85.png']
  }
];
---

<SectionLayout background="white" paddingY="lg" paddingX="lg" maxWidth="xl" className="relative overflow-hidden">
  <div data-services-vertical class="vertical-services">
    <div class="vertical-services__track">
      <div aria-hidden="true" class="vertical-services__pad vertical-services__pad--intro"></div>

      <div data-services-stage class="vertical-services__stage">
        <div class="vertical-services__layout flex flex-col lg:flex-row lg:items-start gap-8 lg:gap-14">
          <div
            class="vertical-services__headline"
            role="group"
            aria-live="polite"
          >
            {services.map((s, idx) => (
              <article
                data-service-headline
                data-service-index={idx}
                class={`vertical-services__headline-item ${idx === 0 ? 'is-active' : 'hidden'}`}
                aria-hidden={idx === 0 ? 'false' : 'true'}
              >
                <div class="vertical-services__headline-card">
                  <Icon name={s.icon} class="vertical-services__headline-icon" />
                  <div class="vertical-services__headline-text">
                    <span class="vertical-services__headline-label">Servicio</span>
                    <p class="vertical-services__headline-number">{s.number}</p>
                    <h3 class="vertical-services__headline-title">{s.title}</h3>
                  </div>
                </div>
              </article>
            ))}

            <div
              class="vertical-services__controls"
              data-service-controls
              role="toolbar"
              aria-label="Cambiar servicio"
              tabindex="0"
            >
              <button
                type="button"
                class="vertical-services__control-button"
                data-service-prev
                aria-label="Servicio anterior"
              >
                <Icon name="ph:arrow-up" class="vertical-services__control-icon" />
              </button>
              <div class="vertical-services__progress" aria-live="polite">
                <span data-service-progress-current class="vertical-services__progress-current">
                  {String(1).padStart(2, '0')}
                </span>
                <span aria-hidden="true" class="vertical-services__progress-separator">/</span>
                <span data-service-progress-total class="vertical-services__progress-total">
                  {String(services.length).padStart(2, '0')}
                </span>
              </div>
              <button
                type="button"
                class="vertical-services__control-button"
                data-service-next
                aria-label="Siguiente servicio"
              >
                <Icon name="ph:arrow-down" class="vertical-services__control-icon" />
              </button>
            </div>
          </div>

          <div data-service-panels class="vertical-services__panels flex-1 space-y-6">
            {services.map((s, idx) => (
              <article
                id={`service-panel-${s.id}`}
                role="group"
                aria-hidden={idx === 0 ? 'false' : 'true'}
                data-service-panel
                data-service-index={idx}
                class={`vertical-services__panel grid gap-6 lg:gap-10 lg:grid-cols-[minmax(0,360px)_minmax(0,1fr)] items-start rounded-3xl border border-neutral-darkest/10 bg-white/70 p-6 lg:p-10 shadow-[0_24px_60px_rgba(15,23,42,0.08)] backdrop-blur ${idx === 0 ? 'is-active' : 'hidden'}`}
              >
                <div class="vertical-services__panel-copy space-y-5 text-neutral-darkest">
                  <div class="flex items-center gap-4">
                    <Icon name={s.icon} class="w-6 h-6 lg:w-7 lg:h-7 text-neutral-darkest" />
                    <div>
                      <p class="font-urbanist text-sm uppercase tracking-[0.35em] text-neutral-darkest/60">{s.number}</p>
                      <h3 class="font-urbanist font-semibold text-2xl lg:text-4xl leading-tight">{s.title}</h3>
                    </div>
                  </div>
                  <p class="font-heebo text-base lg:text-lg text-neutral-darkest/80 leading-relaxed">
                    {s.description}
                  </p>
                  <a
                    href={s.href}
                    class="inline-flex items-center justify-center w-fit mt-2 px-5 py-2.5 rounded-full border-2 border-neutral-darkest text-neutral-darkest font-medium transition-colors hover:bg-neutral-darkest hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-neutral-darkest focus-visible:ring-offset-2"
                  >
                    {s.cta}
                    <Icon name="ph:arrow-right" class="w-5 h-5 ml-2" />
                  </a>
                </div>
                <div class="vertical-services__panel-media">
                  <div class="grid grid-cols-2 grid-rows-3 gap-3 lg:gap-4 h-[300px] lg:h-[520px]">
                    <div class="col-span-2 row-span-1 rounded-xl overflow-hidden border border-neutral-darkest/15">
                      <img src={s.images[0]} alt={s.title} class="w-full h-full object-cover" loading="lazy" />
                    </div>
                    <div class="col-span-1 row-span-1 rounded-xl overflow-hidden border border-neutral-darkest/15">
                      <img src={s.images[1]} alt={s.title} class="w-full h-full object-cover" loading="lazy" />
                    </div>
                    <div class="col-span-1 row-span-2 rounded-xl overflow-hidden border border-neutral-darkest/15">
                      <img src={s.images[2]} alt={s.title} class="w-full h-full object-cover" loading="lazy" />
                    </div>
                    <div class="col-span-1 row-span-1 hidden lg:block"></div>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </div>
      </div>

      <div aria-hidden="true" class="vertical-services__scroll-steps">
        {services.map((_, idx) => (
          <div
            class="vertical-services__scroll-step"
            data-scroll-step
            data-scroll-index={idx}
          ></div>
        ))}
      </div>

      <div aria-hidden="true" class="vertical-services__pad vertical-services__pad--outro"></div>
    </div>
  </div>

  <script is:inline>
    function initServicesVertical() {
      const root = document.querySelector('[data-services-vertical]');
      if (!root) return;

      const headlineItems = Array.from(root.querySelectorAll('[data-service-headline]'));
      const panels = Array.from(root.querySelectorAll('[data-service-panel]'));
      const scrollSteps = Array.from(root.querySelectorAll('[data-scroll-step]'));
      const stage = root.querySelector('[data-services-stage]');
      const controls = root.querySelector('[data-service-controls]');
      const prevButton = controls?.querySelector('[data-service-prev]');
      const nextButton = controls?.querySelector('[data-service-next]');
      const progressCurrent = controls?.querySelector('[data-service-progress-current]');
      const progressTotal = controls?.querySelector('[data-service-progress-total]');

      if (!headlineItems.length || !panels.length) return;

      const total = panels.length;
      if (progressTotal) {
        progressTotal.textContent = String(total).padStart(2, '0');
      }

      const TRANSITION_MS = 650;
      let current = 0;
      let isAnimating = false;
      let pending = null;

      function setActiveState(list, idx) {
        list.forEach((node, i) => {
          const active = i === idx;
          node.classList.toggle('is-active', active);
          node.classList.toggle('hidden', !active);
          if (node.hasAttribute('aria-hidden')) {
            node.setAttribute('aria-hidden', String(!active));
          }
        });
      }

      function updateProgress(idx) {
        if (progressCurrent) {
          progressCurrent.textContent = String(idx + 1).padStart(2, '0');
        }
      }

      function updateDisplay(idx) {
        if (idx < 0 || idx >= total) return;
        setActiveState(headlineItems, idx);
        setActiveState(panels, idx);
        updateProgress(idx);
        current = idx;
      }

      function requestActivation(idx, options = {}) {
        if (idx === current || idx < 0 || idx >= total) {
          return;
        }

        if (options.immediate) {
          isAnimating = false;
          pending = null;
          updateDisplay(idx);
          return;
        }

        if (isAnimating) {
          pending = { idx, options };
          return;
        }

        isAnimating = true;
        stage?.classList.add('is-animating');
        updateDisplay(idx);

        window.setTimeout(() => {
          isAnimating = false;
          stage?.classList.remove('is-animating');

          if (pending && pending.idx !== current) {
            const next = pending;
            pending = null;
            requestActivation(next.idx, next.options);
          } else {
            pending = null;
          }
        }, TRANSITION_MS);
      }

      function goToPrevious() {
        const target = (current - 1 + total) % total;
        requestActivation(target);
      }

      function goToNext() {
        const target = (current + 1) % total;
        requestActivation(target);
      }

      prevButton?.addEventListener('click', goToPrevious);
      nextButton?.addEventListener('click', goToNext);

      controls?.addEventListener('keydown', (event) => {
        switch (event.key) {
          case 'ArrowUp':
          case 'ArrowLeft':
            event.preventDefault();
            goToPrevious();
            break;
          case 'ArrowDown':
          case 'ArrowRight':
            event.preventDefault();
            goToNext();
            break;
          case 'Enter':
          case ' ': {
            event.preventDefault();
            goToNext();
            break;
          }
          default:
            break;
        }
      });

      if (scrollSteps.length) {
        const observer = new IntersectionObserver(
          (entries) => {
            entries
              .filter((entry) => entry.isIntersecting)
              .sort((a, b) => b.intersectionRatio - a.intersectionRatio)
              .forEach((entry) => {
                const indexAttr = entry.target.getAttribute('data-scroll-index');
                const idx = indexAttr ? Number.parseInt(indexAttr, 10) : NaN;
                if (!Number.isNaN(idx)) {
                  requestActivation(idx);
                }
              });
          },
          {
            threshold: 0.6,
            rootMargin: '0px 0px -20% 0px'
          }
        );

        scrollSteps.forEach((step) => observer.observe(step));
      }

      updateDisplay(current);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initServicesVertical, { once: true });
    } else {
      initServicesVertical();
    }
  </script>
</SectionLayout>

<style>
  .vertical-services {
    position: relative;
  }

  .vertical-services__track {
    position: relative;
    display: block;
  }

  .vertical-services__pad {
    width: 100%;
    pointer-events: none;
  }

  .vertical-services__pad--intro {
    height: clamp(18vh, 12rem, 22vh);
  }

  .vertical-services__pad--outro {
    height: clamp(24vh, 18rem, 34vh);
  }

  .vertical-services__stage {
    position: sticky;
    top: clamp(3.5rem, 10vh, 6rem);
    z-index: 2;
    width: 100%;
    transition: transform 0.45s ease, box-shadow 0.45s ease;
    will-change: transform;
  }

  @media (max-width: 1023px) {
    .vertical-services__stage {
      top: clamp(1.5rem, 8vh, 3rem);
    }
  }

  .vertical-services__stage.is-animating {
    transform: translateY(-6px);
  }

  .vertical-services__stage.is-animating .vertical-services__tab {
    pointer-events: none;
  }

  .vertical-services__scroll-steps {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: clamp(14vh, 12vw, 24vh);
    padding-block: clamp(8vh, 6vw, 12vh);
    pointer-events: none;
  }

  .vertical-services__scroll-step {
    width: 100%;
    height: max(68vh, 520px);
  }

  .vertical-services__headline {
    display: flex;
    flex-direction: column;
    gap: clamp(1.5rem, 3vw, 2.75rem);
    max-width: 420px;
  }

  .vertical-services__headline-card {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    padding: clamp(1.75rem, 3vw, 2.75rem);
    border-radius: 2.75rem;
    background: linear-gradient(140deg, rgba(15, 23, 42, 0.94), rgba(15, 23, 42, 0.75));
    color: #f8fafc;
    box-shadow: 0 32px 80px rgba(15, 23, 42, 0.35);
  }

  .vertical-services__headline-icon {
    width: 48px;
    height: 48px;
    color: #f8fafc;
  }

  .vertical-services__headline-text {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .vertical-services__headline-label {
    font-family: 'Urbanist', sans-serif;
    font-size: 0.75rem;
    letter-spacing: 0.35em;
    text-transform: uppercase;
    opacity: 0.65;
  }

  .vertical-services__headline-number {
    font-family: 'Urbanist', sans-serif;
    font-size: clamp(2.5rem, 6vw, 4rem);
    font-weight: 600;
    line-height: 1;
  }

  .vertical-services__headline-title {
    font-family: 'Urbanist', sans-serif;
    font-size: clamp(1.85rem, 3.4vw, 2.8rem);
    font-weight: 600;
    line-height: 1.2;
    max-width: 14ch;
  }

  .vertical-services__controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1.25rem;
  }

  .vertical-services__headline-item.is-active .vertical-services__headline-card {
    animation: headline-fade 0.55s ease forwards;
  }

  .vertical-services__control-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 52px;
    height: 52px;
    border-radius: 50%;
    border: 1px solid rgba(248, 250, 252, 0.25);
    background: rgba(15, 23, 42, 0.85);
    color: #f8fafc;
    transition: transform 0.25s ease, border-color 0.25s ease, background-color 0.25s ease;
  }

  .vertical-services__control-button:hover,
  .vertical-services__control-button:focus-visible {
    transform: translateY(-3px);
    border-color: rgba(248, 250, 252, 0.55);
  }

  .vertical-services__control-icon {
    width: 24px;
    height: 24px;
  }

  .vertical-services__progress {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-family: 'Urbanist', sans-serif;
    font-size: 0.9rem;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    color: rgba(15, 23, 42, 0.72);
    background: rgba(248, 250, 252, 0.9);
    border-radius: 999px;
    padding: 0.55rem 1.4rem;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.15);
  }

  .vertical-services__progress-current {
    font-weight: 600;
  }

  .vertical-services__progress-total {
    opacity: 0.72;
  }

  .vertical-services__progress-separator {
    opacity: 0.4;
  }

  .vertical-services__stage.is-animating .vertical-services__control-button {
    pointer-events: none;
    opacity: 0.5;
    transform: none;
  }

  @media (max-width: 1023px) {
    .vertical-services__headline {
      max-width: none;
    }

    .vertical-services__progress {
      font-size: 0.8rem;
      letter-spacing: 0.22em;
    }
  }

  .vertical-services__panel {
    background: rgba(255, 255, 255, 0.78);
    border-radius: 1.75rem;
  }

  .vertical-services__panel.is-active {
    animation: fade-in-up 0.45s ease forwards;
  }

  @keyframes headline-fade {
    from {
      opacity: 0;
      transform: translateY(12px) scale(0.99);
    }

    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes fade-in-up {
    from {
      opacity: 0;
      transform: translateY(24px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

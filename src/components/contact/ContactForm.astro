---
import { Icon } from "astro-icon/components";
import Button from '../ui/Button.astro';
---

<section class="py-20 bg-gradient-to-br from-slate-900 via-gray-900 to-slate-900 relative overflow-hidden" id="form">
  <!-- Background decorations -->
  <div class="absolute inset-0">
    <div class="absolute top-20 left-20 w-40 h-40 bg-primary-green/10 rounded-full blur-3xl"></div>
    <div class="absolute bottom-20 right-20 w-32 h-32 bg-blue-500/10 rounded-full blur-2xl"></div>
    <div class="absolute top-1/2 right-10 w-24 h-24 bg-purple-500/10 rounded-full blur-xl"></div>
  </div>

  <div class="max-w-7xl mx-auto px-6 relative z-10">
    <!-- Section Header -->
    <div class="text-center max-w-4xl mx-auto mb-16" data-aos="fade-up">
      <div class="inline-flex items-center gap-2 bg-primary-green/10 backdrop-blur-sm border border-primary-green/20 rounded-full px-4 py-2 mb-6">
        <Icon name="ph:pencil-fill" class="w-5 h-5 text-primary-green" />
        <span class="text-primary-green font-semibold text-sm">Formulario de Contacto</span>
      </div>
      
      <h2 class="text-4xl lg:text-6xl font-bold text-white leading-tight mb-6">
        Cuéntanos Sobre Tu <span class="bg-gradient-to-r from-primary-green to-emerald-400 bg-clip-text text-transparent">Proyecto</span>
      </h2>
      
      <p class="text-xl text-gray-300 leading-relaxed">
        Completa el formulario y nos pondremos en contacto contigo en menos de 24 horas para discutir tu proyecto
      </p>
    </div>

    <div class="grid lg:grid-cols-2 gap-12 items-start">
      <!-- Contact Form -->
      <div class="bg-white/5 backdrop-blur-sm rounded-3xl p-8 border border-white/10" data-aos="fade-right" data-aos-delay="100">
        <form id="contactForm" class="space-y-6">
          <!-- Personal Information -->
          <div class="grid md:grid-cols-2 gap-6">
            <div class="form-group">
              <label for="firstName" class="block text-sm font-semibold text-white mb-3">
                <Icon name="ph:user" class="w-4 h-4 inline mr-2" />
                Nombre *
              </label>
              <input 
                type="text" 
                id="firstName" 
                name="firstName" 
                required
                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent transition-all duration-200"
                placeholder="Tu nombre"
              />
              <div class="error-message text-red-400 text-sm mt-1 hidden"></div>
            </div>

            <div class="form-group">
              <label for="lastName" class="block text-sm font-semibold text-white mb-3">
                <Icon name="ph:user" class="w-4 h-4 inline mr-2" />
                Apellido *
              </label>
              <input 
                type="text" 
                id="lastName" 
                name="lastName" 
                required
                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent transition-all duration-200"
                placeholder="Tu apellido"
              />
              <div class="error-message text-red-400 text-sm mt-1 hidden"></div>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="grid md:grid-cols-2 gap-6">
            <div class="form-group">
              <label for="email" class="block text-sm font-semibold text-white mb-3">
                <Icon name="ph:envelope" class="w-4 h-4 inline mr-2" />
                Email *
              </label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                required
                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent transition-all duration-200"
                placeholder="tu@email.com"
              />
              <div class="error-message text-red-400 text-sm mt-1 hidden"></div>
            </div>

            <div class="form-group">
              <label for="phone" class="block text-sm font-semibold text-white mb-3">
                <Icon name="ph:phone" class="w-4 h-4 inline mr-2" />
                Teléfono *
              </label>
              <input 
                type="tel" 
                id="phone" 
                name="phone" 
                required
                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent transition-all duration-200"
                placeholder="+593 99 999 9999"
              />
              <div class="error-message text-red-400 text-sm mt-1 hidden"></div>
            </div>
          </div>

          <!-- Project Type -->
          <div class="form-group">
            <label for="projectType" class="block text-sm font-semibold text-white mb-3">
              <Icon name="ph:buildings" class="w-4 h-4 inline mr-2" />
              Tipo de Proyecto *
            </label>
            <select 
              id="projectType" 
              name="projectType" 
              required
              class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent transition-all duration-200"
            >
              <option value="" disabled selected class="text-gray-400">Selecciona el tipo de proyecto</option>
              <option value="residential" class="text-gray-900">Construcción Residencial</option>
              <option value="commercial" class="text-gray-900">Construcción Comercial</option>
              <option value="renovation" class="text-gray-900">Remodelación</option>
              <option value="maintenance" class="text-gray-900">Mantenimiento</option>
              <option value="other" class="text-gray-900">Otro</option>
            </select>
            <div class="error-message text-red-400 text-sm mt-1 hidden"></div>
          </div>

          <!-- Budget Range -->
          <div class="form-group">
            <label for="budget" class="block text-sm font-semibold text-white mb-3">
              <Icon name="ph:currency-dollar" class="w-4 h-4 inline mr-2" />
              Presupuesto Estimado
            </label>
            <select 
              id="budget" 
              name="budget"
              class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent transition-all duration-200"
            >
              <option value="" disabled selected class="text-gray-400">Selecciona un rango (opcional)</option>
              <option value="under-20k" class="text-gray-900">Menos de $20,000</option>
              <option value="20k-50k" class="text-gray-900">$20,000 - $50,000</option>
              <option value="50k-100k" class="text-gray-900">$50,000 - $100,000</option>
              <option value="100k-200k" class="text-gray-900">$100,000 - $200,000</option>
              <option value="over-200k" class="text-gray-900">Más de $200,000</option>
            </select>
          </div>

          <!-- Timeline -->
          <div class="form-group">
            <label for="timeline" class="block text-sm font-semibold text-white mb-3">
              <Icon name="ph:calendar" class="w-4 h-4 inline mr-2" />
              Cronograma Deseado
            </label>
            <select 
              id="timeline" 
              name="timeline"
              class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent transition-all duration-200"
            >
              <option value="" disabled selected class="text-gray-400">¿Cuándo te gustaría empezar?</option>
              <option value="asap" class="text-gray-900">Lo antes posible</option>
              <option value="1-month" class="text-gray-900">Dentro de 1 mes</option>
              <option value="3-months" class="text-gray-900">Dentro de 3 meses</option>
              <option value="6-months" class="text-gray-900">Dentro de 6 meses</option>
              <option value="flexible" class="text-gray-900">Soy flexible</option>
            </select>
          </div>

          <!-- Project Description -->
          <div class="form-group">
            <label for="message" class="block text-sm font-semibold text-white mb-3">
              <Icon name="ph:note" class="w-4 h-4 inline mr-2" />
              Descripción del Proyecto *
            </label>
            <textarea 
              id="message" 
              name="message" 
              required
              rows="6"
              class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent transition-all duration-200 resize-none"
              placeholder="Cuéntanos más sobre tu proyecto. Incluye detalles como ubicación, tamaño, requisitos especiales, etc."
            ></textarea>
            <div class="error-message text-red-400 text-sm mt-1 hidden"></div>
            <div class="text-sm text-gray-400 mt-1">
              <span id="charCount">0</span>/500 caracteres
            </div>
          </div>

          <!-- Terms and Privacy -->
          <div class="form-group">
            <label class="flex items-start gap-3 cursor-pointer">
              <input 
                type="checkbox" 
                id="terms" 
                name="terms" 
                required
                class="mt-1 w-5 h-5 text-primary-green bg-white/10 border border-white/20 rounded focus:ring-primary-green focus:ring-2"
              />
              <span class="text-sm text-gray-300 leading-relaxed">
                Acepto los <a href="/terminos" class="text-primary-green hover:underline">términos y condiciones</a> y la 
                <a href="/privacidad" class="text-primary-green hover:underline">política de privacidad</a>. 
                Autorizo el procesamiento de mis datos para contacto relacionado con este proyecto. *
              </span>
            </label>
            <div class="error-message text-red-400 text-sm mt-1 hidden"></div>
          </div>

          <!-- Submit Button -->
          <div class="pt-4">
            <Button type="submit" variant="success" class="w-full group" id="submitBtn">
              <Icon name="ph:paper-plane-tilt-fill" class="w-5 h-5 group-hover:translate-x-1 transition-transform" />
              <span id="submitText">Enviar Solicitud</span>
            </Button>
          </div>

          <!-- Success/Error Messages -->
          <div id="successMessage" class="hidden bg-green-500/20 border border-green-500/30 rounded-xl p-4 text-green-300">
            <div class="flex items-center gap-3">
              <Icon name="ph:check-circle-fill" class="w-6 h-6 text-green-400" />
              <div>
                <div class="font-semibold">¡Mensaje enviado exitosamente!</div>
                <div class="text-sm">Nos pondremos en contacto contigo pronto.</div>
              </div>
            </div>
          </div>

          <div id="errorMessage" class="hidden bg-red-500/20 border border-red-500/30 rounded-xl p-4 text-red-300">
            <div class="flex items-center gap-3">
              <Icon name="ph:warning-circle-fill" class="w-6 h-6 text-red-400" />
              <div>
                <div class="font-semibold">Error al enviar el mensaje</div>
                <div class="text-sm">Por favor, intenta nuevamente o contáctanos directamente.</div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Contact Information & Benefits -->
      <div class="space-y-8" data-aos="fade-left" data-aos-delay="200">
        <!-- Why Contact Us -->
        <div class="bg-white/5 backdrop-blur-sm rounded-3xl p-8 border border-white/10">
          <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
            <Icon name="ph:star-fill" class="w-6 h-6 text-yellow-400" />
            ¿Por qué elegirnos?
          </h3>
          
          <div class="space-y-4">
            <div class="flex items-start gap-4">
              <div class="w-10 h-10 bg-primary-green/20 rounded-xl flex items-center justify-center flex-shrink-0 mt-1">
                <Icon name="ph:medal-fill" class="w-5 h-5 text-primary-green" />
              </div>
              <div>
                <div class="font-semibold text-white">15+ Años de Experiencia</div>
                <div class="text-gray-300 text-sm">Equipo especializado en construcción y remodelación</div>
              </div>
            </div>

            <div class="flex items-start gap-4">
              <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center flex-shrink-0 mt-1">
                <Icon name="ph:shield-check-fill" class="w-5 h-5 text-blue-400" />
              </div>
              <div>
                <div class="font-semibold text-white">Garantía Completa</div>
                <div class="text-gray-300 text-sm">Todos nuestros proyectos incluyen garantía integral</div>
              </div>
            </div>

            <div class="flex items-start gap-4">
              <div class="w-10 h-10 bg-purple-500/20 rounded-xl flex items-center justify-center flex-shrink-0 mt-1">
                <Icon name="ph:clock-fill" class="w-5 h-5 text-purple-400" />
              </div>
              <div>
                <div class="font-semibold text-white">Respuesta Rápida</div>
                <div class="text-gray-300 text-sm">Te contactamos en menos de 24 horas</div>
              </div>
            </div>

            <div class="flex items-start gap-4">
              <div class="w-10 h-10 bg-green-500/20 rounded-xl flex items-center justify-center flex-shrink-0 mt-1">
                <Icon name="ph:calculator-fill" class="w-5 h-5 text-green-400" />
              </div>
              <div>
                <div class="font-semibold text-white">Cotización Gratuita</div>
                <div class="text-gray-300 text-sm">Evaluación y presupuesto sin costo</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Process Steps -->
        <div class="bg-white/5 backdrop-blur-sm rounded-3xl p-8 border border-white/10">
          <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
            <Icon name="ph:steps-fill" class="w-6 h-6 text-primary-green" />
            Nuestro Proceso
          </h3>
          
          <div class="space-y-6">
            <div class="flex items-start gap-4">
              <div class="w-8 h-8 bg-primary-green rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">1</div>
              <div>
                <div class="font-semibold text-white">Consulta Inicial</div>
                <div class="text-gray-300 text-sm">Analizamos tus necesidades y requerimientos</div>
              </div>
            </div>

            <div class="flex items-start gap-4">
              <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">2</div>
              <div>
                <div class="font-semibold text-white">Evaluación y Propuesta</div>
                <div class="text-gray-300 text-sm">Visita técnica y cotización detallada</div>
              </div>
            </div>

            <div class="flex items-start gap-4">
              <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">3</div>
              <div>
                <div class="font-semibold text-white">Planificación</div>
                <div class="text-gray-300 text-sm">Diseño detallado y cronograma del proyecto</div>
              </div>
            </div>

            <div class="flex items-start gap-4">
              <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">4</div>
              <div>
                <div class="font-semibold text-white">Ejecución</div>
                <div class="text-gray-300 text-sm">Construcción con seguimiento constante</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Emergency Contact -->
        <div class="bg-gradient-to-br from-red-500/20 to-orange-500/20 backdrop-blur-sm rounded-3xl p-8 border border-red-500/30">
          <h3 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
            <Icon name="ph:siren-fill" class="w-6 h-6 text-red-400" />
            Emergencias 24/7
          </h3>
          <p class="text-gray-300 mb-6">¿Tienes una emergencia de construcción? Te atendemos las 24 horas.</p>
          
          <div class="flex flex-col sm:flex-row gap-4">
            <Button variant="outline" href="tel:+593956324598" class="border-red-400 text-red-400 hover:bg-red-500 hover:text-white flex-1">
              <Icon name="ph:phone-fill" class="w-4 h-4" />
              Llamada de Emergencia
            </Button>
            <Button variant="outline" href="https://wa.me/593956324598?text=EMERGENCIA" class="border-orange-400 text-orange-400 hover:bg-orange-500 hover:text-white flex-1">
              <Icon name="ph:whatsapp-logo-fill" class="w-4 h-4" />
              WhatsApp Urgente
            </Button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('contactForm') as HTMLFormElement;
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
    const submitText = document.getElementById('submitText') as HTMLSpanElement;
    const successMessage = document.getElementById('successMessage') as HTMLDivElement;
    const errorMessage = document.getElementById('errorMessage') as HTMLDivElement;
    const messageTextarea = document.getElementById('message') as HTMLTextAreaElement;
    const charCount = document.getElementById('charCount') as HTMLSpanElement;

    // Character counter for message
    messageTextarea.addEventListener('input', () => {
      const count = messageTextarea.value.length;
      charCount.textContent = count.toString();
      
      if (count > 500) {
        charCount.classList.add('text-red-400');
        charCount.classList.remove('text-gray-400');
      } else {
        charCount.classList.remove('text-red-400');
        charCount.classList.add('text-gray-400');
      }
    });

    // Phone number formatting
    const phoneInput = document.getElementById('phone') as HTMLInputElement;
    phoneInput.addEventListener('input', (e) => {
      let value = (e.target as HTMLInputElement).value.replace(/\D/g, '');
      if (value.length > 10) value = value.slice(0, 10);
      
      if (value.length >= 6) {
        value = value.replace(/(\d{3})(\d{3})(\d{4})/, '$1 $2 $3');
      } else if (value.length >= 3) {
        value = value.replace(/(\d{3})(\d{3})/, '$1 $2');
      }
      
      (e.target as HTMLInputElement).value = value;
    });

    // Real-time validation
    const validateField = (field: HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement): boolean => {
      const formGroup = field.closest('.form-group') as HTMLElement;
      const errorMessage = formGroup.querySelector('.error-message') as HTMLElement;
      let isValid = true;
      let message = '';

      // Clear previous states
      field.classList.remove('border-red-500', 'border-green-500');
      errorMessage.classList.add('hidden');

      if (field.hasAttribute('required') && !field.value.trim()) {
        isValid = false;
        message = 'Este campo es obligatorio';
      } else if (field.type === 'email' && field.value) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(field.value)) {
          isValid = false;
          message = 'Ingresa un email válido';
        }
      } else if (field.type === 'tel' && field.value) {
        const phoneRegex = /^\d{3}\s\d{3}\s\d{4}$/;
        if (!phoneRegex.test(field.value)) {
          isValid = false;
          message = 'Ingresa un teléfono válido (10 dígitos)';
        }
      } else if (field.id === 'message' && field.value.length > 500) {
        isValid = false;
        message = 'El mensaje no puede exceder 500 caracteres';
      }

      if (!isValid) {
        field.classList.add('border-red-500');
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
      } else if (field.value.trim()) {
        field.classList.add('border-green-500');
      }

      return isValid;
    };

    // Add validation listeners
    const formFields = form.querySelectorAll('input, textarea, select') as NodeListOf<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>;
    formFields.forEach(field => {
      field.addEventListener('blur', () => validateField(field));
      field.addEventListener('input', () => {
        if (field.classList.contains('border-red-500')) {
          validateField(field);
        }
      });
    });

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Validate all fields
      let isFormValid = true;
      formFields.forEach(field => {
        if (!validateField(field)) {
          isFormValid = false;
        }
      });

      // Check terms acceptance
      const termsCheckbox = document.getElementById('terms') as HTMLInputElement;
      if (!termsCheckbox.checked) {
        isFormValid = false;
        const termsGroup = termsCheckbox.closest('.form-group') as HTMLElement;
        const termsError = termsGroup.querySelector('.error-message') as HTMLElement;
        termsError.textContent = 'Debes aceptar los términos y condiciones';
        termsError.classList.remove('hidden');
      }

      if (!isFormValid) {
        // Scroll to first error
        const firstError = form.querySelector('.border-red-500') as HTMLElement;
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      submitText.textContent = 'Enviando...';
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');

      try {
        // Simulate form submission (replace with actual endpoint)
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Show success message
        successMessage.classList.remove('hidden');
        form.reset();
        
        // Reset character counter
        charCount.textContent = '0';
        
        // Remove validation classes
        formFields.forEach(field => {
          field.classList.remove('border-red-500', 'border-green-500');
        });
        
        // Scroll to success message
        successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
      } catch (error) {
        // Show error message
        errorMessage.classList.remove('hidden');
        errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitText.textContent = 'Enviar Solicitud';
      }
    });
  });
</script>